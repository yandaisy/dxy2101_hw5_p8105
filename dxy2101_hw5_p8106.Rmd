---
title: "dxy2101_hw5_p8106"
author: "Daisy Yan"
date: "2022-11-10"
output: github_document
---

```{r setup, message=FALSE}
library(tidyverse)
library(ggplot2)
```

## Problem 1

Create a tidy dataframe containing data from all participants, including the subject ID, arm, and observations over time.

```{r study, message=FALSE}
# Load data
study_files =
  tibble(files = list.files("./data")) %>%
  mutate(files = str_c("data", files, sep = "/"))

study_data =
  study_files %>%
  mutate(subjects = map(files, read_csv)) %>%
  mutate(arm = case_when(str_detect(files, "exp") ~ "experiment",
                         str_detect(files, "con") ~ "control"),
         sub_id = as.factor(parse_number(files))) %>%
  unnest(subjects) %>%
  pivot_longer(cols = week_1:week_8, names_to = "week", values_to = "observations") %>%
  mutate(week = as.numeric(parse_number(week)))
```

Make spaghetti plot.

```{r pasta}
study_data %>%
  ggplot(aes(x = week, y = observations, color = sub_id)) +
  geom_line() + ylab("Observations") + xlab("Weeks") +
  facet_grid(cols = vars(arm)) +
  ggtitle("Observations of Subjects Over Time")
```

In the control group, subjects report similar observations over time. On the other hand, in the experimental group, subjects reeport higher observations over time.

## Problem 2

Describe raw dataset.

```{r homicides, message=FALSE}
# Load data
url = 'https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv'

homicide_data =
  read_csv(url)
```

The homicide data set contains `r nrow(homicide_data)` observations and `r ncol(homicide_data)` variables. The variables included are the following: unique id, reported date, victim characteristics (last name, first name, race, age, sex), location of case (city, state, latitude, longitude), and disposition of case.

Create `city_state` variable. Summarize within cities to obtain number of solved homicides and unsolved homicides.

```{r city, message=FALSE}
# Create new variables and clean
homicide_data =
  homicide_data %>%
  mutate(city_state = str_c(city, state, sep = ", "),
         status = case_when(
           disposition == "Closed without arrest" ~ "unsolved",
           disposition == "Open/No arrest" ~ "unsolved",
           disposition == "Closed by arrest" ~ "solved"
         )) %>%
  select(-city, -state, -disposition) %>%
  relocate(city_state, .before = lat)

# Summarize
status_summary =
  homicide_data %>%
  group_by(city_state, status) %>%
  summarise(count = n())
```

Estimate proportion of unsolved homicides in Baltimore, MD.

```{r baltimore}
# Filter to Baltimore
baltimore_data =
  homicide_data %>%
  filter(city_state == "Baltimore, MD") %>%
  summarise(
    unsolved = sum(status == "unsolved"),
    total = n()
  )

# prop.test
baltimore_prop =
  prop.test(
    x = baltimore_data$unsolved,
    n = baltimore_data$total
  )

baltimore_estimate =
  baltimore_prop %>%
  broom::tidy()
```

Estimate proportion of unsolved homicides in all cities.

```{r all cities, message=FALSE, warning=FALSE}
# Create function to run prop.test
prop_function = function(cities){
  
  cities_data  =
    cities %>%
    summarise(
      unsolved = sum(status == "unsolved"),
      total = n()
    )
  
  cities_prop =
    prop.test(
      x = cities_data %>% pull(unsolved),
      n = cities_data %>% pull(total)
    )
  
  cities_prop
}

# Test prop_function
prop_function(
  homicide_data%>%
  filter(city_state == "Baltimore, MD"))

# Iterate across all cities
results = 
  homicide_data %>% 
    nest(-city_state) %>% 
    mutate(
      test = map(data, prop_function),
      tidy = map(test, broom::tidy)
    ) %>% 
    select(city_state, tidy) %>% 
    unnest(tidy) %>% 
    select(city_state, estimate, starts_with('conf'))

results
```

Plot estimates of CIs for each city.

```{r plot CI}
results %>%
  mutate(
    city_state = fct_reorder(city_state, estimate)
  ) %>%
  ggplot(aes(x = city_state, y = estimate)) + geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  xlab("City, State") + ylab("Proportion of Unsolved Homicides") +
  ggtitle("Estimated Proportion of Unsolved Homicides by City")
```

